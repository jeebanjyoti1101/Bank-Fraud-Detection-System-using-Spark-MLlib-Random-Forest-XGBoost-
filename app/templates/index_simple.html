<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fraud Detection System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .main-card { max-width: 800px; margin: 0 auto; background: white; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 15px 15px 0 0; text-align: center; }
        .form-section { padding: 30px; }
        .form-label { font-weight: 600; color: #333; margin-bottom: 8px; }
        .form-control, .form-select { border: 2px solid #e0e0e0; border-radius: 8px; padding: 12px; }
        .form-control:focus, .form-select:focus { border-color: #667eea; box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25); }
        .btn-predict { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; color: white; padding: 15px 40px; font-size: 18px; font-weight: 600; border-radius: 8px; width: 100%; margin-top: 20px; }
        .btn-predict:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4); }
        .result-card { margin-top: 30px; border-radius: 10px; padding: 30px; text-align: center; display: none; }
        .result-fraud { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; }
        .result-safe { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; }
        .probability-badge { font-size: 48px; font-weight: 700; margin: 20px 0; }
        .info-text { background: #f8f9fa; border-left: 4px solid #667eea; padding: 15px; margin: 20px 0; border-radius: 5px; }
        .feature-importance { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 20px; }
        .feature-item { background: rgba(255,255,255,0.95); color: #333; padding: 10px; border-radius: 5px; font-size: 14px; }
        .feature-item strong { color: #333; }
        .feature-item span { color: #333; }
        .model-badge { display: inline-block; background: white; color: #667eea; padding: 5px 15px; border-radius: 20px; margin: 5px; font-size: 14px; font-weight: 600; }
        .result-card h5, .result-card h6 { color: white; font-weight: 600; margin-top: 20px; }
        .result-card .text-start { background: rgba(255,255,255,0.95); color: #333; padding: 15px; border-radius: 8px; margin-top: 10px; }
        .result-card .text-start small { color: #333; font-size: 14px; line-height: 1.8; }
        .result-card .feature-importance * { color: #333 !important; }
    </style>
</head>
<body>
    <div class="main-card">
        <div class="header">
            <h1><i class="fas fa-shield-alt"></i> Fraud Detection System</h1>
            <p class="mb-0">AI-Powered Transaction Analysis</p>
            <div class="mt-3">
                <span class="model-badge">Random Forest</span>
                <span class="model-badge">XGBoost</span>
                <span class="model-badge">LightGBM</span>
                <span class="model-badge">CatBoost</span>
                <span class="model-badge">Gradient Boosting</span>
            </div>
        </div>

        <div class="form-section">
                        <p class="text-center" style="color: #000; margin-bottom: 30px;">
                <i class="fas fa-info-circle"></i> <strong>How it works:</strong> Enter transaction details below. Our AI models analyze patterns learned from 1M+ real transactions with 94.46% accuracy.
            </p>

            <form id="fraudForm">
                <div class="row">
                    <!-- Transaction Type -->
                    <div class="col-md-6 mb-3">
                        <label class="form-label">
                            <i class="fas fa-exchange-alt text-primary"></i> Transaction Type
                        </label>
                        <select class="form-select" name="type" required>
                            <option value="">Select Type</option>
                            <option value="PAYMENT">PAYMENT - Buy goods/services</option>
                            <option value="TRANSFER">TRANSFER - Send money</option>
                            <option value="CASH_OUT">CASH_OUT - Withdraw cash</option>
                            <option value="CASH_IN">CASH_IN - Deposit cash</option>
                            <option value="DEBIT">DEBIT - Card payment</option>
                        </select>
                        <small class="text-muted">TRANSFER & CASH_OUT have higher fraud risk</small>
                    </div>

                    <!-- Transaction Amount -->
                    <div class="col-md-6 mb-3">
                        <label class="form-label">
                            <i class="fas fa-dollar-sign text-success"></i> Transaction Amount
                        </label>
                        <input type="number" class="form-control" name="amount" step="0.01" required placeholder="e.g., 50000">
                        <small class="text-muted">Larger amounts are analyzed more carefully</small>
                    </div>

                    <!-- Balance Before -->
                    <div class="col-md-6 mb-3">
                        <label class="form-label">
                            <i class="fas fa-wallet text-warning"></i> Account Balance (Before)
                        </label>
                        <input type="number" class="form-control" name="oldbalanceOrg" step="0.01" required placeholder="e.g., 100000">
                        <small class="text-muted">Balance before this transaction</small>
                    </div>

                    <!-- Balance After -->
                    <div class="col-md-6 mb-3">
                        <label class="form-label">
                            <i class="fas fa-wallet text-info"></i> Account Balance (After)
                        </label>
                        <input type="number" class="form-control" name="newbalanceOrig" step="0.01" required placeholder="e.g., 50000">
                        <small class="text-muted">Balance after amount is subtracted</small>
                    </div>
                </div>

                <button type="submit" class="btn btn-predict">
                    <i class="fas fa-search"></i> Analyze Transaction
                </button>
            </form>

            <!-- Result Section -->
            <div id="resultCard" class="result-card">
                <h2 id="resultTitle"></h2>
                <div class="probability-badge" id="resultProbability"></div>
                <p id="resultMessage"></p>
                
                                <div class="mt-4">
                    <h5>AI Model Predictions:</h5>
                    <div class="feature-importance">
                        <div class="feature-item" style="background: #f0f8ff; color: #000; border: 2px solid #4facfe;">
                            <strong style="color: #000;">Random Forest:</strong> <span id="rfProb" style="color: #667eea; font-weight: 700;"></span>
                        </div>
                        <div class="feature-item" style="background: #f0f8ff; color: #000; border: 2px solid #4facfe;">
                            <strong style="color: #000;">XGBoost:</strong> <span id="xgbProb" style="color: #667eea; font-weight: 700;"></span>
                        </div>
                        <div class="feature-item" style="background: #f0f8ff; color: #000; border: 2px solid #4facfe;">
                            <strong style="color: #000;">LightGBM:</strong> <span id="lgbProb" style="color: #667eea; font-weight: 700;"></span>
                        </div>
                        <div class="feature-item" style="background: #f0f8ff; color: #000; border: 2px solid #4facfe;">
                            <strong style="color: #000;">CatBoost:</strong> <span id="catProb" style="color: #667eea; font-weight: 700;"></span>
                        </div>
                        <div class="feature-item" style="background: #f0f8ff; color: #000; border: 2px solid #4facfe;">
                            <strong style="color: #000;">Gradient Boosting:</strong> <span id="gbProb" style="color: #667eea; font-weight: 700;"></span>
                        </div>
                    </div>
                </div>

                <div class="mt-4">
                    <h6>Key Factors Analyzed:</h6>
                    <div class="text-start" style="background: white; color: #000; padding: 15px; border-radius: 8px; margin-top: 10px; border: 2px solid rgba(255,255,255,0.5);">
                        <small id="keyFactors" style="color: #000; font-size: 14px; line-height: 1.8;"></small>
                    </div>
                </div>

                <button class="btn btn-light mt-3" onclick="resetForm()">
                    <i class="fas fa-redo"></i> Check Another Transaction
                </button>
            </div>
        </div>
    </div>

    <script>
        document.getElementById('fraudForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);
            
            // Convert to numbers
            data.amount = parseFloat(data.amount);
            data.oldbalanceOrg = parseFloat(data.oldbalanceOrg);
            data.newbalanceOrig = parseFloat(data.newbalanceOrig);
            data.oldbalanceDest = 0;
            data.newbalanceDest = 0;

            try {
                const response = await fetch('/api/predict', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                
                // Check if there's an error in the response
                if (result.error) {
                    alert('Error: ' + (Array.isArray(result.error) ? result.error.join(', ') : result.error));
                    return;
                }
                
                displayResult(result, data);
            } catch (error) {
                alert('Error: ' + error.message);
            }
        });

        function displayResult(result, inputData) {
            // Safety check
            if (!result || result.fraud_probability === undefined) {
                alert('Error: Invalid response from server. Please try again.');
                return;
            }
            
            const resultCard = document.getElementById('resultCard');
            const isFraud = result.is_fraud;
            const probability = result.fraud_probability;

            // Set card style
            resultCard.className = isFraud ? 'result-card result-fraud' : 'result-card result-safe';
            resultCard.style.display = 'block';

            // Set title and probability
            document.getElementById('resultTitle').innerHTML = isFraud 
                ? '<i class="fas fa-exclamation-triangle"></i> FRAUD DETECTED' 
                : '<i class="fas fa-check-circle"></i> TRANSACTION SAFE';
            document.getElementById('resultProbability').textContent = probability.toFixed(1) + '%';
            
            // Set message
            document.getElementById('resultMessage').innerHTML = isFraud
                ? '<strong>High Risk:</strong> This transaction shows fraud patterns. Review carefully before processing.'
                : '<strong>Low Risk:</strong> This transaction appears legitimate. Safe to proceed.';

            // Model predictions
            const comp = result.components;
            document.getElementById('rfProb').textContent = comp.rf_probability ? comp.rf_probability + '%' : 'N/A';
            document.getElementById('xgbProb').textContent = comp.xgb_probability ? comp.xgb_probability + '%' : 'N/A';
            document.getElementById('lgbProb').textContent = comp.lgb_probability ? comp.lgb_probability + '%' : 'N/A';
            document.getElementById('catProb').textContent = comp.cat_probability ? comp.cat_probability + '%' : 'N/A';
            document.getElementById('gbProb').textContent = comp.gb_probability ? comp.gb_probability + '%' : 'N/A';

            // Key factors
            const factors = [];
            if (inputData.type === 'TRANSFER' || inputData.type === 'CASH_OUT') {
                factors.push('• High-risk transaction type: ' + inputData.type);
            }
            if (inputData.amount > 200000) {
                factors.push('• Large transaction amount: $' + inputData.amount.toLocaleString());
            }
            const balanceChange = inputData.oldbalanceOrg - inputData.newbalanceOrig;
            const drainPercent = (balanceChange / inputData.oldbalanceOrg * 100);
            if (drainPercent > 90) {
                factors.push('• High balance drain: ' + drainPercent.toFixed(1) + '% of account');
            }
            const expectedBalance = inputData.oldbalanceOrg - inputData.amount;
            const balanceError = Math.abs(expectedBalance - inputData.newbalanceOrig);
            if (balanceError > 0.01) {
                factors.push('• Balance inconsistency detected: $' + balanceError.toFixed(2));
            }

            document.getElementById('keyFactors').innerHTML = factors.length > 0 
                ? factors.join('<br>') 
                : '• Standard transaction pattern<br>• Balances are consistent<br>• Amount within normal range';

            // Scroll to result
            resultCard.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function resetForm() {
            document.getElementById('fraudForm').reset();
            document.getElementById('resultCard').style.display = 'none';
        }
    </script>
</body>
</html>
